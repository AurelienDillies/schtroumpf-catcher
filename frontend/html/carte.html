<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte</title>

    <link rel="icon" type="image/png" href="static/image/logo.png">

    <link rel="stylesheet" href="static/css/head-foot.css">
    <link rel="stylesheet" href="static/css/carte.css">

    <!--initialisation de la carte leaflet-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!---------------------------------------------------------------------------->

    <!--style minimal de la carte (obligatoire)-->
</head>

<body>
    <header>
        <div class="header-logo">
            <a href="./">
                <img src="static/image/logo.png" alt="logo du site">
                <p>schtroumpf catcher</p>
            </a>
        </div>
        <div class="header-nav">
            <nav>
                <ul>
                    <li><a href="./">Accueil</a></li>
                    <li><a href="./carte">Carte</a></li>
                    <li><a href="./ajout">Ajout d'un schtroumpf</a></li>
                    <li><a href="./contact">Contact</a></li>
                </ul>
            </nav>
        </div>
        <div class="connexion">
            <a href="./connexion"><img src="static/image/Smurf_house.png" alt="logo de connexion / inscription"></a>
        </div>
    </header>

    <main>
        <div id="map"></div> <!--div ou la map est insérée-->

        <script>
            // initialiser la carte 
            var map = L.map('map', {
                center: [46.5, 2.5],
                zoom: 6,
                minZoom: 1.4,   //  empêche d’aller trop loin
                maxZoom: 18   //  évite de zoomer trop
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                noWrap: true,                // empêche la répétition horizontale
                bounds: [[-90, -180], [90, 180]] // limite aux coordonnées du globe
            }).addTo(map);


            // initialiser les points
            var pointBleu = L.icon({
                iconUrl: 'static/image/point-bleu.png',

                iconSize: [38, 95], // size of the icon
                iconAnchor: [22, 94], // point of the icon which will correspond to marker's location
                popupAnchor: [-3, -76] // point from which the popup should open relative to the iconAnchor
            });

            var pointRouge = L.icon({
                iconUrl: 'static/image/point-rouge.png',

                iconSize: [38, 95], // size of the icon
                iconAnchor: [22, 94], // point of the icon which will correspond to marker's location
                popupAnchor: [-3, -76] // point from which the popup should open relative to the iconAnchor
            });

            // Fonction pour capturer un schtroumpf
            function captureSchtroumpf(id) {
                fetch(`http://127.0.0.1:8000/items/${id}/capture`, {
                    method: "PUT"
                })
                .then(response => {
                    if (!response.ok) throw new Error("Erreur lors de la capture");
                    return response.json();
                })
                .then(data => {
                    alert(`${data.nom} a été attrapé !`);
                    location.reload();
                })
                .catch(error => console.error("Erreur:", error));
            }

            // Charger les schtroumpfs
            function fetchData() {
                fetch("http://127.0.0.1:8000/items/")
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(schtroumpf => {
                            if (!schtroumpf.capture) {
                                let icon = schtroumpf.grand ? pointRouge : pointBleu;
                                L.marker([schtroumpf.latitude, schtroumpf.longitude], { icon: icon })
                                    .addTo(map)
                                    .bindPopup(`
                                    <div class="popup-content">
                                        <h3>${schtroumpf.nom}</h3>
                                        <p>${schtroumpf.description}</p>
                                        <div class="btn-attrape">
                                        <button onclick="captureSchtroumpf(${schtroumpf.id})" class="attrape">Attraper</button>
                                        </div>
                                    </div>
                                    `);
                            }
                        });
                    })
                    .catch(error => console.error("Failed to fetch data:", error));
            }

            fetchData();
        </script>
    </main>



    <!-----------------------Footer----------------------------->
    <footer>
        <div class="copyright">
            <p><span id="current-year"></span> &copy; Schtroumpf Catcher. Tous droits réservés.</p>
        </div>
        <div class="footer-nav">
            <ul>
                <li><a href="./contact">Contact</a></li>
            </ul>
        </div>
    </footer>
    <script>
        // Mise à jour de l'année dans le footer
        document.getElementById('current-year').textContent = new Date().getFullYear();
    </script>
</body>

</html>
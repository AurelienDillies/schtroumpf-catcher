<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte</title>

    <link rel="icon" type="image/png" href="../image/logo.png">

    <link rel="stylesheet" href="static/css/head-foot.css">
    <link rel="stylesheet" href="static/css/ajout.css">

    <!--initialisation de la carte leaflet-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!---------------------------------------------------------------------------->

    <!--style minimal de la carte (obligatoire)-->
    <style>
    
    </style>


</head>

<body>
    <!-------------------Header----------------->
    <header>
        <div class="header-logo">
            <a href="static/html/index.html">
                <img src="static/image/logo.png" alt="logo du site">
                <p>schtroumpf catcher</p>
            </a>
        </div>
        <div class="header-nav">
            <nav>
                <ul>
                    <li><a href="./">Accueil</a></li>
                    <li><a href="./carte">Carte</a></li>
                    <li><a href="./ajout">Ajout d'un schtroumpf</a></li>
                    <li><a href="./contact">Contact</a></li>
                </ul>
            </nav>
        </div>
        <div class="connexion">
            <a href="./connexion"><img src="static/image/Smurf_house.png" alt="logo de connexion / inscription"></a>
        </div>
    </header>
    <!----------------------------------------->

    <main>
        <div id="container-ajout"> <!--contient div carte et div formulaire-->

            <div id="mapAjout"></div>

            <script>

                // ---------------- initialiser carte ------------------
                var mapAjout = L.map('mapAjout', {
                center: [46.7, 2.8],
                zoom: 9,
                minZoom: 1.4,   //  emp√™che d‚Äôaller trop loin
                maxZoom: 15   //  √©vite de zoomer trop
            });

                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                noWrap: true,                // emp√™che la r√©p√©tition horizontale
                bounds: [[-90, -180], [90, 180]] // limite aux coordonn√©es du globe
                }).addTo(mapAjout);

                // --------------- Initialise les icones possibles -------
                var pointBleu = L.icon({
                    iconUrl: 'static/image/point-bleu.png',

                    iconSize: [38, 95], // size of the icon
                    iconAnchor: [22, 94], // point of the icon which will correspond to marker's location
                    popupAnchor: [-3, -76] // point from which the popup should open relative to the iconAnchor
                });

                var pointRouge = L.icon({
                    iconUrl: 'static/image/point-rouge.png',

                    iconSize: [38, 95], // size of the icon
                    iconAnchor: [22, 94], // point of the icon which will correspond to marker's location
                    popupAnchor: [-3, -76] // point from which the popup should open relative to the iconAnchor
                });

                var pointBlanc = L.icon({
                    iconUrl: 'static/image/point-blanc.png',

                    iconSize: [38, 95], // size of the icon
                    iconAnchor: [22, 94], // point of the icon which will correspond to marker's location
                    popupAnchor: [-3, -76] // point from which the popup should open relative to the iconAnchor
                });

                // r√©cup√®re les donn√©es des schtroumpfs en json et les affiche sur la carte

                function fetchJSONData() {
                    fetch('./items/')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            data.forEach(schtroumpf => {
                                if (schtroumpf.grand == true) {
                                    L.marker([schtroumpf.latitude, schtroumpf.longitude], { icon: pointRouge })
                                        .addTo(mapAjout)
                                        .bindPopup("<h3>" + schtroumpf.nom + "</h3>");
                                }
                                else {
                                    L.marker([schtroumpf.latitude, schtroumpf.longitude], { icon: pointBleu })
                                        .addTo(mapAjout)
                                        .bindPopup("<h3>" + schtroumpf.nom + "</h3>");
                                }
                            });
                        })
                        .catch(error => console.error('Failed to fetch data:', error));
                }

                fetchJSONData();


                //------------ Point d√©placable nouveau schtroumpf -----------------

                mapAjout.invalidateSize(); 

                var marker = L.marker([46.7, 2.8], {
                    icon: pointBlanc,
                    draggable: true
                }).addTo(mapAjout);


                marker.on("drag", function(e) {
                    var marker = e.target;
                    var position = marker.getLatLng();
                    document.getElementById("latitude").value = position.lat;
                    document.getElementById("longitude").value = position.lng;
                });


                // ---------- ajouter donn√©es nouveau schtroumpf en appuyant sur le bouton

                document.addEventListener("DOMContentLoaded", function () {
                    document.getElementById('boutonAjouter').addEventListener('click', async function () {
                        const latitude = parseFloat(document.getElementById('latitude').value);
                        const longitude = parseFloat(document.getElementById('longitude').value);
                        const nom = document.getElementById('nom').value;
                        const grand = document.getElementById('grand').checked;
                        const capture = false;

                        // G√©n√©rer un ID unique bas√© sur timestamp
                        const id = Date.now();

                        const newSchtroumpf = {
                            id: id,
                            nom: nom,
                            latitude: latitude,
                            longitude: longitude,
                            grand: grand,
                            capture: capture
                        };

                        try {
                            // üîπ Envoi vers le backend FastAPI
                            const response = await fetch('http://127.0.0.1:8000/items/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(newSchtroumpf)
                            });

                            if (!response.ok) {
                                const err = await response.json();
                                throw new Error(err.detail || 'Erreur lors de l‚Äôajout');
                            }

                            alert("Schtroumpf ajout√© avec succ√®s !");
                            location.reload(); // recharge la page si besoin
                        } catch (error) {
                            console.error("Erreur :", error);
                            alert("Impossible d‚Äôajouter le Schtroumpf : " + error.message);
                        }
                    });
                });



            </script>

            <div id="formulaire-ajout">
                <div >
                    <h4 id ="titre-formulaire">Ajouter un Schtroumpf</h4>
                    <p id ="sous-titre">D√©placez le marqueur pour choisir la position</p>
                </div>
                <form>
                    <div class="element-formulaire">
                        <label for="latitude">Latitude</label>
                        <input type="text" id="latitude" name="latitude" readonly>
                    </div>
                    <div class="element-formulaire">
                        <label for="longitude">Longitude</label>
                        <input type="text" id="longitude" name="longitude" readonly>
                    </div>
                    <div class="element-formulaire">
                        <label for="nom">Nom du Schtroumpf :</label>
                        <input type="text" id="nom" name="nom" placeholder="Nom du schtroumpf">
                    </div>
                    <div class="element-formulaire">
                        <label for="grand">Grand Schtroumpf ? :</label>
                        <input type="checkbox" id="grand" name="grand">
                    </div>
                    <div class="centre">
                        <button type="button" id="boutonAjouter">Ajouter</button>
                    </div>
            </div>
        </div>


    </main>


    <!-----------------------Footer----------------------------->
    <footer>
        <div class="copyright">
            <p><span id="current-year"></span> &copy; Schtroumpf Catcher. Tous droits r√©serv√©s.</p>
        </div>
        <div class="footer-nav">
            <ul>
                <li><a href="./contact">Contact</a></li>
            </ul>
        </div>
    </footer>
    <script>
        // Mise √† jour de l'ann√©e dans le footer
        document.getElementById('current-year').textContent = new Date().getFullYear();
    </script>
</body>

</html>